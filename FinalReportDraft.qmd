---
title: "Final Report Draft"
title-block-banner: true
author: 
- Sean Leader
- William Medwid
- Vanessa Veto
- Jose Mierzejewski
format: 
  html:
    code-fold: true
    code-line-numbers: true
    code-tools: true
    self-contained: true
    theme: cosmo
  
editor: visual
execute:
  message: false
  include: false
  echo: false
---

```{r}
library(tidyverse)
library(here)
library(lubridate)
library(knitr)
```

```{r}
aqi <- read_csv(here("Project Data",
                     "Combined",
                     "aqi_ozone_all_years_prediction.csv"))
```

```{r}
aqi
```

# Introduction

-   Feel free to rewrite this section as much as you'd like, I just put some general details in here based on phase 2 for the time being

The EPA is an organization fundamentally invested securing and promoting the health and well-being of the environment. In this paper, we analyze two distinct but related environmental issues: air pollution and car dependency. For both issues, we used publicly available data sourced from the EPA to construct machine learning models to make predictions. For air pollution, we predicted a county's next-day Air Quality Index (AQI) from the previous day's atmospheric conditions to determine which factors contribute to AQI and how accurately we can determine tomorrow's AQI from today's conditions. For car dependency, we predicted the 'walkability' category of a localized area based on demographic information to deduce which demographic characteristics contribute most meaningfully to the 'walkability' of a location.

```{r}
# Previous Work - should we include this??? If so, we need to update citations in appendix

"Previous research has used similar methods to model AQI based on related conditions. One paper specifically models the AQI of Zhangdian District, China based on industrial waste gas emissions as well as general meteorological data. Their goals were to promote the optimization of polluting enterprises and to reduce the conflict between environmental protection and economic development. They compared results from a random forest, a back propagation neural network, a decision tree, and a least-squares SVM, ultimately preferring the Random Forest for its high accuracy, with an R-Squared value of 0.9. (Liu, Y. et al.) 

One paper in the American Journal of Epidemiology used a linear regression approach to understand how income, education, racial/ethnic composition, age distribution, and sex were associated with indicators of neighborhood walkability. They found that neighborhoods with poorer residents tended to be more walkable, but with less open space. Similarly, children and the elderly tended to live in less walkable spaces, limiting their independence. (Katherine E. King et al.) Our work will be similar in that we are also trying to predict walkability and gain insight on what makes certain places more walkable than others. Our analysis will be different because we have many more variables to work with and we plan on taking a classification approach. 

Another article with goals similar to goals of our projectâ€™s is this paper. These researchers also analyzed walkability, but viewed it only through the lens of the built environment, rather than including sociodemographic characteristics. Additionally, this paper specifically focused on a single metropolitan area whereas we will use data from all 50 U.S. states (and Washington D.C.). These researchers used PCA as their main analysis. (Denc, C. et al.) We plan on also using PCA, but only as a preprocessing step before fitting KNN models. Overall, this study uses very similar predictors and target variables to ours, and we hope to expand upon its findings."
```

# Data Collection & Description

## AQI

To collect information about atmospheric conditions and Air Quality Index, we downloaded two years (2021 & 2022) worth of atmospheric data from the EPA (source in the appendix). These data were collected by various monitoring stations across 43 counties in 32 states across the United States on a daily basis. In the final data set, one observation corresponded to one day of atmospheric measurements for a particular county, with multiple measurements from different weather stations. We had to omit some of the observations because predicting next-day AQI from current-day atmospheric conditions requires sequential days where all atmospheric measurements at that monitoring station are present. Sequential days that were missing any of the atmospheric measurements on either day were omitted from the data.

**There are different AQIs for different atmospheric pollutants. For this project, we chose to predict the AQI based on ozone from atmospheric conditions (excluding ozone concentration) because the ozone AQI was the most frequent of the different AQIs after all data merging was complete.**

**For each atmospheric measurement, we extracted the minimum, average, and maximum measurement at each weather station each day.** The following table details the atmospheric measurements we extracted.

```{r, fig.cap = "Table 1. Variable summary for AQI dataset", include = TRUE}
data.frame(`Variable Name` = c("no2", "co", "so2", 
                               "no", "temp","wind", 
                                   "pressure", "humid", "AQI"),
           `Variable Description` = 
             c("Atmospheric Concentration of Nitrogen Dioxide (ppb)",
               "Atmospheric Concentration of Carbon Monoxide (ppm)",
               "Atmospheric Concentration of Sulfur Dioxide (ppb)",
               "Atmospheric Concentration of Nitrogen Monoxide (ppb)",
               "Temperature (Celsius)",
               "Wind Speed (knots)",
               "Barometric Pressure (millibars)",
               "Relative Humidity (% rh)",
               "Next-day Air Quality Index, measured by Ozone")) %>%
  rename(`Variable Name` = Variable.Name,
         `Variable Description` = Variable.Description) %>%
  kable()
```

## Walkability

**PLEASE ADD SECTION ABOUT DATA COLLECTION AND DESCRIPTION FOR WALKABILITY DATA**

# Exploratory Data Analysis

## AQI

### Overall distribution of AQI

```{r, fig.cap = "Figure 1. Overall distribution of AQI", include = TRUE, message = FALSE}
ggplot(aqi, aes(AQI_next_day, fill = cut(AQI_next_day, 100))) +
  geom_histogram(show.legend = FALSE) +
  scale_fill_discrete(h = c(200, 10), c = 200, l = 70) + 
  theme_bw() + 
  labs(y = "",
       x = "AQI") 
```

```{r, fig.cap = "Table 2. Summary statistics of AQI", include = TRUE}
aqi %>% 
  summarise(Mean = round(mean(AQI_next_day), 2),
            SD = round(sd(AQI_next_day), 2),
            Median = median(AQI_next_day),
            IQR = IQR(AQI_next_day)) %>%
  kable()
```

Overall, the distribution of AQI scores is single-peaked and right-skewed, with a median next-day AQI of 44 and an interquartile range of 30. The graph is likely right-skewed because AQI is bounded on the lower end by 0, but has no upper limit.

<br /> <br />

### Overall distribution of AQI by month

```{r, fig.cap = "Figure 2. Distribution of AQI by month", include = TRUE}
aqi %>%
  mutate(Month = factor(month(Date, label = TRUE))) %>%
  ggplot(aes(x = Month, y = AQI_next_day, fill = Month)) + 
  geom_boxplot() + 
  theme_bw() + 
  theme(legend.position = "None") + 
        #axis.title.y = element_text(angle = 0, vjust = 0.5)) +
  labs(y = "") +
  scale_fill_manual(values = c("#034E7B", "#0570B0", "#3690C0", "#74A9CF", "#A6BDDB", "#D0D1E6",
                                          "#F1EEF6", "#D0D1E6", "#A6BDDB", "#74A9CF", "#3690C0", "#0570B0"))
```

Figure 2 reveals the seasonal trend in AQI. AQI tends to be higher in the summer months and lower in the winter months for these data. The exact mechanism for this relationship is unknown, but some hypotheses include:

(1) Extreme heat and stagnant air can lead to an increase in ground-level ozone concentrations
(2) Hot and dry weather results in forest fires that can increase atmospheric pollutants
(3) Clouds are less common at higher temperatures but are important for preventing the production of ozone

```{r}
"https://scied.ucar.edu/learning-zone/air-quality/how-weather-affects-air-quality#:~:text=Heat%20waves%20often%20lead%20to,ozone%20pollution%20and%20particulate%20pollution."
```

<br /> <br />

### Correlations between predictors and AQI

```{r, fig.cap = "Figure 3. Predictor correlations with AQI, by min, mean, and max concentration", include = TRUE}
aqi %>% select(-Date, -County, -State, 
               -AQI, -AQI_cat, -max_ozone, 
               -mean_ozone, -min_ozone) %>%
  cor() %>% 
  data.frame() %>%
  select(AQI_next_day) %>% 
  mutate(variable = rownames(.),
         variable_category = str_replace(variable, ".+_", ""),
         variable_type = str_replace(variable, "_.+", "")) %>%
  filter(variable != "AQI_next_day") %>%
  rename("Correlation" = AQI_next_day) %>%
  ggplot(aes(x = factor(variable_category, 
                        levels = c("no2", "temp", "co", 
                                   "so2", "no", "wind", 
                                   "pressure", "humid")), y = Correlation, fill = variable_type)) + 
  geom_col(position = "dodge", width = 0.75) +
  theme_bw() +
  scale_fill_manual(values = c("#88CCEE", "#CC6677", "#DDCC77")) +
  labs(y = "Correlation",
       x = "Predictor",
       fill = "") +
  ylim(c(-0.6, 0.6))
```

Figure 3 shows how the different atmospheric measurements correlate with next-day AQI. For most atmospheric measurements, the correlation is in the same direction for the minimum, mean, and maximum. However, wind speed is a notable exception to this trend, where we can see that although the mean and minimum wind speed are negatively correlated with next-day AQI, the maximum wind speed has a slight positive correlation with next-day AQI. The single variable with the most positive correlation is maximum no2, with a correlation of \~0.59. The single variable with the most negative correlation is minimum humidity, with a correlation of \~-0.50.

<br /> <br />

```{r}
# Correlation between each variable and next-day AQI 
aqi %>% select(-Date, -County, -State, 
               -AQI, -AQI_cat, -max_ozone, 
               -mean_ozone, -min_ozone) %>%
  cor() %>% data.frame() %>% select(AQI_next_day) 
```

## Walkability

**PLEASE ADD EDA FOR WALKABILITY HERE**

# Model Results

-   This section is meant to detail empirical results from the model building process
-   What were the performance metrics for each of the models?
-   What variables were not

## AQI

We used three different types of models to predict AQI: linear models, decision trees, and random forests. Each model predicts the next day's AQI based on the min, mean, and max values of our 8 predictor measurements. Notably, this does not include any measurements of the day's Ozone or AQI. We measured each model's performance by cross-validating on data the model had not been trained on. The R-Squared and Root Mean Squared Error metrics are displayed below:

```{r, fig.cap = "Table 2. Accuracy metrics for our four model varieties", include = TRUE}
tibble(
  "Model" = c("Linear Regression", "Decision Tree", "Random Forest"),
  "R-Squared" = c(0.5901049, 0.5552405, 0.6756383),
  "Root Mean Squared Error" = c(23.33427, 24.3146, 20.95272)) %>% 
  kable(digits = 3)
```

These metrics indicate that the Random Forest is our overall most effective model, with an R-Squared value of 0.676 and a RMSE of 20.953. This indicates that the random forest could successfully predict 67.6% of the variability in AQI, only being wrong by an average of about 20.953 AQI points. Our linear model was markedly worse, with a RMSE of 23.334, and our decision tree fared the worst, with a RMSE of 24.315 AQI points.

To investigate the biases of each of our models, we have plotted the residual errors below:

![Figure 4: AQI model residual plots. A moving average of the mean error is plotted to display model biases](AQI_residuals.png)

With these results in mind, we will briefly discuss each model's strengths and weaknesses.

### Linear Model

Our final linear model ended up slightly biased with its lowest predictions being under the true AQI, and its higher predictions tending to over-predict by about 10 points. After comparing several linear model specifications, we settled on this model which uses our predictors in both their original and squared forms to predict AQI. This allowed us to reduce the biases on the high and low somewhat, but some bias remained.

Despite its biases and inaccuracies, the linear model is useful for its interpretability. We found three of our predictors to be far more important than the others by using LASSO regression, giving us a simple understanding of the basic associations at play. See the formula below:

$$
AQI = 58.68 + 12.43 * max\_no2 + 8.43 * max\_temperature - 6.36 * min\_humidity
$$

Note that in this formula, max_no2, max_temperature, and max_humidity are standardized, measured in standard deviations rather than typical units. This gives us a simple understanding that high no2 and temperature in a day indicate high AQI, while humidity indicates lower AQI. The association between no2 and ozone makes a lot of sense, as both are typically generated from fossil cars and industrial facilities, so we would expect them to be highly correlated. Despite being so simplified, this model still has a RMSE of only 26.169, and a R-squared of 0.484.

### Decision Tree

Our decision tree's predictions look far different than the others because they are made in discrete categories rather than in a more continuous manner. While this model has little bias, with only a slight overestimation bias on its highest predictions of 144, it has the largest overall errors, making it a worse predictor than other models. Neverhteless, this model may be very valuable, as we can directly see how it makes its decisions in the following decision tree flowchart:

![Figure 5: Decision Tree Flowchart](AQI_decision_tree.png)

At each step, this decision tree chooses one variable to best separate high-AQI days from low-AQI days. The first, largest, split separates based on no2: days with a very low no2, below 18 ppb, are directed to the left side of the tree, which tends to have lower AQI. This split makes sense because ozone and no2 tend to come from the same sources such as cars and industrial facilities, so a low no2 concentration correlate with low ozone. For low no2 days, the tree finds that high temperature is the best indicator of high AQI, with humidity distinguishing further days with a max temperature between 68 and 82 degrees Fahrenheit. For high no2 days, the tree uses air pressure and temperature to distinguish AQI further.

### Random Forest

Our final optimized random forest model averages the results of 500 decision trees, each of which is trained on a random subset of 6 of our predictors, a random subset of our data, and splits into many more AQI categories than the decision tree above. This leads each of the individual decision trees to over-fit to different small trends in our training data. By taking the average of so many over-fit trees, each of which recognizes different indicators of AQI, the random forest is very effective at predicting AQI, but does not lend itself to a more detailed human understanding.

## Walkability

**you know what to put here :\^)**

# Discussion

-   The goal of this discussion is to make inferences from the model results and EDA in the previous sections
-   Touch on what we learned from each model building process for both questions
-   For the interpretable models, what factors were most important (already touched on this in the Model Results) and what can we conclude because of that?
-   Were we successfully able to predict each of the responses?
-   If so, what does that tell us about AQI/Walkability?
-   If not, what does that tell us AQI/Walkability?

-   We don't necessarily need separate sections for AQI and walkability here, but only combine them if it seems natural to do so


## AQI

Our model results demonstrate that we can forecast ozone-based AQI effectively without knowledge of ozone levels. On average, our random forest was only wrong by 20.953 AQI points, rarely predicting far from the actual AQI. As the estimates are in the same ballpark as the real AQI, they could potentially serve to give the public a general idea of how unsafe atmospheric ozone levels are in the absence of ozone measurements. We tuned several models for various parameters in order to arrive at this accurate of a random forest predictor. While our other models didn't prove to be as impactful, the linear model gives us an intuitive understanding that ozone is associated with high no2, high temperatures, and low humidity.

## Walkability

# Ethics

## Good uses of our work

It is important that as we give you these powerful machine learning model fits, you are aware of the importance of their proper usage. We hope that you will use the work detailed in this report to better understand the atmospheric factors that contribute to the future air quality of an area and the demographic characteristics that determine its walkability. For the AQI model in particular, we also expect that you can use this model to effectively predict the air quality based on ozone even when direct ozone measurements are unable to be taken, using other atmospheric conditions as a proxy measurement. For the walkability model, we would support the usage of our models to predict areas with poor walkability for areas where it is unknown, such that changes could be implemented to make it more pedestrian-friendly.

## Misuses

Although there are many appropriate uses of our work, we also want to forewarn you about the potential misuses to avoid. Primarily, though our models predict ozone-based AQI, it should not be used as a proxy for AQI when proper measurements are available, as it could miss some important and dangerous fluctuations. The model's intended use is as an emergency measure, when ozone measurements are not available.

As the EPA, it is your responsibility to use the knowledge gained from this work and the corresponding machine learning models to help the environment, not to harm it. If large polluters use these models to find ways to disguise their harmful ozone production, this could ultimately do more harm than good. For example, if they learn that cold, humid days see low ozone, they may choose emit more fumes during those times and harm the larger environment. 

## Bias

We must acknowledge that our project is subject to biases - deliberate or otherwise. The primary bias in this analysis came from the data collection process. Our final data set consisted of atmospheric measurements from only 43 counties across 32 states, meaning that a substantial portion of the country is left unaccounted for by this analysis. Also, we did not investigate the geographic locations of the weather stations that were monitoring the atmospheric conditions; hence it is possible that these measurements are not representative of the general population of atmospheric conditions. Finally, the data we analyzed came only from the years 2021 and 2022 - meaning that insights and trends illuminated in this report may not reflect the historical patterns.

**PLEASE ADD SECITON REGARDING BIAS FOR WALKABILITY DATASET**

# Conclusion

-   Reiterate what we learned from the discussion and potentially from the EDA
-   How do these learnings relate to the questions we asked at the beginning?
-   Consider modifying the introduction as conclusions come naturally - the introduction should allude to what we talk about in this section, and vice versa
-   Make sure to tie these answers back to the original intent of this paper (recall that we are writing this report FOR the EPA.)

# Appendix

## Sources

How Weather Affects Air Quality \| Center for Science Education. (n.d.). UCAR. <https://scied.ucar.edu/learning-zone/air-quality/how-weather-affects-air-quality>

-   This is where sources we used should be linked. Please cite them in some proper format, not just hyperlinks (example above).
-   Any additional output from model summaries that did not fit earlier in the paper could go here as well

## Additional Output
