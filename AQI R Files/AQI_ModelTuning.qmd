---
title: "AQI Prediction"
author: "Sean Leader // William Medwid // Vanessa Veto // Jose Mierzejewski"
format: 
  html:
    code-fold: true
    code-line-numbers: true
    code-tools: true
    self-contained: true
editor: visual
execute:
  message: false
---

```{r packages, message = FALSE}
# Load Packages

library(tidyverse)
library(tidymodels)
library(glmnet)
library(here)
library(rpart)
library(rpart.plot)
```

```{r}
aqi_ozone <- read_csv(here("Project Data", "Combined", "aqi_ozone_all_years_prediction.csv"))
```

```{r}
set.seed(13)

aqi_ozone_cvs <- aqi_ozone %>% 
  vfold_cv(k = 5)
```


## Linear models

```{r}
lin_reg_tune <- linear_reg(penalty = tune(), mixture = tune()) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

full_recipe <- recipe(AQI_next_day ~ ., data = aqi_ozone) %>% 
  step_normalize() %>% 
  step_interact(terms = ~max_wind:mean_ozone + max_wind : max_ozone) %>% 
  step_rm(c("Date", "State", "County", "AQI_cat"))

lam_grid = grid_regular(penalty(), mixture(c(0,1)), levels = 4)

lm_wf <- workflow() %>% 
  add_model(lin_reg_tune) %>% 
  add_recipe(full_recipe)

grid_results <- lm_wf %>% 
  tune_grid(resamples = aqi_ozone_cvs, grid = lam_grid)

grid_results %>% 
  collect_metrics() %>% 
  filter(.metric == "rsq") %>% 
  arrange(desc(mean))
```

Out of many penalty and mixture parameters, we found a mixture of 1/3 to work best. Each of the small 

```{r}
lm_best_spec <- linear_reg(penalty = 0, mixture = 1) %>%
  set_engine("glmnet") %>%
  set_mode("regression")

#Using same recipe as aboev

lm_best_wf <- workflow() %>% 
  add_model(lm_best_spec) %>% 
  add_recipe(full_recipe)

lm_best_fit <- lm_best_wf %>% 
  fit(aqi_ozone)

lm_best_fit %>% 
  extract_fit_parsnip() %>% 
  tidy() %>% 
  arrange(desc(abs(estimate)))
```

Max ozone has a positive coeficient while min ozone has a similar (slightly smaller) negative coeficient. This could indicate that days with a max much higher than the mean are starting to have worse air quality. Until a high penalty parameter (~2, mixture = 1), min_ozone as a negative coeficient remains important, with min_ozone being the 6th to last variable to become insignificant as penalty increases. The rest of the best are: Max Ozone, AQI, min_no2, max_temp, min_humid

```{r}
lm_best_fit %>% 
  predict(aqi_ozone) %>% 
  mutate(truth = aqi_ozone$AQI_next_day,
         err = truth - .pred) %>% 
  ggplot(aes(x = .pred, y = err)) +
  geom_point()
```

Our predictions appear to be linearly associated with the next day's ozone, with some fanning (larger variance for larger predictions).




# Random Forest 

```{r}
rf_mod <- rand_forest(mtry = tune(), min_n = tune()) %>%
  set_engine("ranger") %>%
  set_mode("regression")


basic_recipe <- recipe(AQI_next_day ~ ., data = aqi_ozone) %>% 
  step_normalize() %>% 
  step_rm(c("Date", "State", "County", "AQI_cat"))


rf_wf <- workflow() %>% 
  add_model(rf_mod) %>% 
  add_recipe(basic_recipe)


rf_grid <- grid_regular(min_n(c(100, 200)),
                        mtry(c(4, 6)),
                        levels = 2)

grid_resulst <- rf_wf %>% 
  tune_grid(resamples = aqi_ozone_cvs,
            grid = rf_grid)

grid_resulst %>% 
  collect_metrics() %>% 
  filter(.metric == "rsq") %>% 
  arrange(desc(mean))
```

# Decision Tree

```{r}
no_aqi_recipe <- recipe(AQI_next_day ~ ., data = aqi_ozone) %>% 
  step_normalize() %>% 
  step_rm(c("Date", "State", "County", "AQI_cat", "AQI"))
```

```{r}
tree_mod <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode("regression")

tree_wflow <- workflow() %>%
  add_recipe(no_aqi_recipe) %>%
  add_model(tree_mod)
```

```{r}
tree_fit <- tree_wflow %>%
  fit_resamples(aqi_ozone_cvs)

tree_fit %>% collect_metrics()
```

### Tree plotted




```{r}
tree_fit_1 <- tree_wflow %>%
  fit(aqi_ozone)

tree_fit_1$fit
```

```{r}
tree_fitted <- tree_fit_1 %>% 
  pull_workflow_fit()

rpart.plot(tree_fitted$fit)
```

# KNN



